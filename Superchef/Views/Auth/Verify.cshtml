@section head {
    <style>
        #request-verification {
            --_verification-bg: var(--verification-bg, #f5f5f5);
            --_verification-content: var(--verification-content, "");
            --_verification-content-color: var(--verification-content-color, #9abc66);
            --_verification-content-status: var(--verification-content-status, "");
            --_verification-content-desc: var(--verification-content-desc, "");

            width: max-content;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: var(--font-display);
        }

        #request-verification.check {
            --verification-bg: #f8faf5;
            --verification-content: "✓";
            --verification-content-color: #9abc66;
            --verification-content-status: "Success";
            --verification-content-desc: "Your request has been successfully verified";
        }

        #request-verification.cross {
            --verification-bg: #faf5f5;
            --verification-content: "✗";
            --verification-content-color: #d9534f;
            --verification-content-status: "Invalid Token";
            --verification-content-desc: "Please try requesting it again";
        }

        #request-verification.incorrect {
            --verification-bg: #faf5f5;
            --verification-content: "✗";
            --verification-content-color: #d9534f;
            --verification-content-status: "Incorrect";
            --verification-content-desc: "Please check your email for the correct OTP and try again";
        }

        #request-verification.link {
            --verification-bg: #f5f5f5;
            --verification-content: "✉︎";
            --verification-content-color: #666666;
            --verification-content-status: "Link Sent";
            --verification-content-desc: "Please check your email and enter the OTP to continue";
        }

        #request-verification.expired {
            --verification-bg: #f5f5f5;
            --verification-content: "⏱︎";
            --verification-content-color: #f59e0b;
            --verification-content-status: "Expired";
            --verification-content-desc: "Your request has expired. Please try requesting it again";
        }

        #request-verification .image {
            width: 10rem;
            height: 10rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6rem;
            font-weight: var(--font-weight-bold);
        }

        #request-verification .image {
            background-color: var(--_verification-bg);
        }

        #request-verification .image::after {
            content: var(--_verification-content);
            color: var(--_verification-content-color);
        }

        #request-verification .status-title::after {
            content: var(--_verification-content-status);
            color: var(--_verification-content-color);
        }

        #request-verification .status-title {
            margin-top: 1.25rem;
            font-size: 2rem;
            font-weight: var(--font-weight-semibold);
        }

        #request-verification .desc {
            font-size: 1.125rem;
            text-align: center;
            margin-bottom: 3rem;
        }

        #request-verification .desc::after {
            content: var(--_verification-content-desc);
            white-space: pre-wrap;
        }

        #otp-container {
            display: none;
            gap: 0.5rem;
            grid-template-columns: repeat(6, clamp(2rem, 10vw, 3rem));
        }

        #otp-container input {
            width: 100%;
            aspect-ratio: 1 / 1;
            border: 1px solid var(--border-otp);
            color: var(--text-primary);
            text-align: center;
            padding: 0;
            outline: none;
            font-size: 1.25rem;
            font-family: var(--font-display);
            font-weight: var(--font-weight-semibold);
        }

        #request-verification.link #otp-container {
            display: inline-grid;
        }
    </style>
}

<div id="request-verification" class="container container-center @ViewBag.Status">
    <div class="image"></div>
    <div class="status-title"></div>
    <div class="desc"></div>

    <div id="otp-container">
        <input type="text" maxlength="1">
        <input type="text" maxlength="1">
        <input type="text" maxlength="1">
        <input type="text" maxlength="1">
        <input type="text" maxlength="1">
        <input type="text" maxlength="1">
    </div>

    @if (ViewBag.Status == "incorrect")
    {
        <button id="try-again-button" data-button="accent">Try Again</button>
    }
    else if (ViewBag.Status != "link")
    {
        if (ViewBag.ReturnUrl == "/")
        {
            <a href="/" id="request-button" data-button="@(ViewBag.Status == "check" ? "success" : "accent")">Back to
                Homepage</a>
        }
        else
        {
            <a href="@ViewBag.ReturnUrl" id="request-button" data-button="success">Continue</a>
        }
    }
</div>


@section foot {
    <script>
        $("#otp-container input").on("input", function (ev) {
            const value = $(this)
                .val()
                .replace(/[^0-9]/g, "")
            if (value === "") {
                $(this).val("")
            } else if ($(this).next("input")[0]) {
                $(this).next("input").focus()
            }

            if (
                $("#otp-container input").filter(function () {
                    return $(this).val() !== ""
                }).length === 6
            ) {
                $("#otp-container input").off("keydown")
                $("#otp-container input").off("input")
                $("#otp-container input").prop("readonly", true)
                submitOTP()
            }
        })

        $("#otp-container input").on("keydown", function (ev) {
            if (ev.code === "Backspace" && $(this).val() === "" && $(this).prev("input")[0]) {
                $(this).prev("input").focus()
            }
        })

        $("#otp-container input").on("paste", function (ev) {
            ev.preventDefault()
            const paste = (ev.originalEvent || ev).clipboardData.getData("text")
            const digits = paste.replace(/[^0-9]/g, "").split("")
            $("#otp-container input").each(function (index) {
                if (digits[index]) {
                    $(this).val(digits[index])
                }
            })
            if (digits.length === 6) {
                $("#otp-container input").off("keydown")
                $("#otp-container input").off("input")
                $("#otp-container input").prop("readonly", true)
                submitOTP()
            }
        })

        $("#try-again-button").on("click", function () {
            const urlParams = new URLSearchParams(window.location.search)
            urlParams.delete("otp")
            window.location.href = window.location.pathname + "?" + urlParams.toString()
        })

        function submitOTP() {
            const urlParams = new URLSearchParams(window.location.search)
            urlParams.set("otp", $("#otp-container input")
                .map(function () {
                    return $(this).val()
                })
                .get()
                .join(""))
            window.location.href = window.location.pathname + "?" + urlParams.toString()
        }

    </script>


    @if (ViewBag.VerificationDeviceId != null && ViewBag.VerificationToken != null)
    {
        {
            <script>
                const verificationDeviceId = @ViewBag.VerificationDeviceId;
                const verificationConnection = new signalR.HubConnectionBuilder().withUrl("/VerificationHub").build()

                verificationConnection.on("Error", (message) => showToast(message))

                verificationConnection.on("Initialized", (serverDeviceId) => {
                    if (serverDeviceId !== verificationDeviceId) {
                        verificationConnection.stop()
                    }
                })

                verificationConnection.on("Disconnect", () => {
                    verificationConnection.stop()
                })

                verificationConnection.on("Verified", async (serverDeviceId) => {
                    if (serverDeviceId !== verificationDeviceId) return

                    $.ajax({
                        url: "/Auth/ClaimSession",
                        method: "post",
                        success: funtion() {
                            window.location.href = "@ViewBag.ReturnUrl";
                        },
                        error: function(xhr, textStatus, errorThrown) {
                            showToast(xhr.responseText)
                        },
                    })
                })

                verificationConnection.start().then(() => {
                    verificationConnection.invoke("Initialize", "@ViewBag.VerificationToken")
                })
            </script>
        }
    }
}